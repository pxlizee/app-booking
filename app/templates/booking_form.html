{% extends 'base.html' %}
{% block title %}{% if edit_mode %}Edit Jadwal{% else %}Booking Jadwal Baru{% endif %}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header fw-bold">
        <i class="bi {% if edit_mode %}bi-pencil-square{% else %}bi-plus-circle-fill{% endif %} me-2"></i>
        {% if edit_mode %}Edit Jadwal yang Sudah Ada{% else %}Buat Booking Jadwal Baru{% endif %}
    </div>
    <div class="card-body p-4">
        <form action="{% if edit_mode %}{{ url_for('routes.update_jadwal', jadwal_id=jadwal_id) }}{% else %}{{ url_for('routes.submit_booking') }}{% endif %}" method="POST">
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="dosen" class="form-label">Nama Dosen</label>
                    <input type="text" class="form-control" id="dosen" name="dosen" value="{{ form_data.nama_dosen or '' }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="matkul" class="form-label">Mata Kuliah</label>
                    <input type="text" class="form-control" id="matkul" name="matkul" value="{{ form_data.mata_kuliah or '' }}" required>
                </div>
            </div>

            <div class="row align-items-center">
                <div class="col-md-4 mb-3">
                    <label for="kelas" class="form-label">Kelas</label>
                    <input type="text" class="form-control" id="kelas" name="kelas" value="{{ form_data.kelas or '' }}" required>
                </div>
                 <div class="col-md-4 mb-3">
                    <label for="sks" class="form-label">SKS</label>
                    <input type="number" class="form-control" id="sks" name="sks" value="{{ form_data.sks or '' }}" required min="1">
                </div>
                <div class="col-md-4 mb-3 pt-4">
                    <div class="form-check form-switch fs-5">
                      <input class="form-check-input" type="checkbox" role="switch" id="tipe_kelas_switch" {% if form_data.tipe_kelas == 'Offline' or not form_data.tipe_kelas %}checked{% endif %}>
                      <label class="form-check-label" for="tipe_kelas_switch">Kelas Offline</label>
                      <input type="hidden" id="tipe_kelas" name="tipe_kelas" value="{{ form_data.tipe_kelas or 'Offline' }}">
                    </div>
                </div>
            </div>
            <hr>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="hari" class="form-label">Hari</label>
                    <select class="form-select" id="hari" name="hari" required>
                        <option value="" disabled>-- Pilih Hari --</option>
                        {% for h in ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'] %}
                            <option value="{{ h }}" {% if form_data.hari == h %}selected{% endif %}>{{ h }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="jam_mulai" class="form-label">Jam Mulai</label>
                    <input type="time" class="form-control" id="jam_mulai" name="jam_mulai" value="{{ form_data.jam_mulai or '' }}" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="jam_selesai" class="form-label">Jam Selesai</label>
                    <input type="time" class="form-control" id="jam_selesai" name="jam_selesai" value="{{ form_data.jam_selesai or '' }}" required>
                </div>
            </div>

            <div class="row" id="lokasi-section">
                <div class="col-md-4 mb-3">
                    <label for="gedung" class="form-label">Gedung</label>
                    <select class="form-select" id="gedung" name="gedung"></select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="lantai" class="form-label">Lantai</label>
                    <select class="form-select" id="lantai" name="lantai"></select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="ruangan" class="form-label">Ruangan</label>
                    <select class="form-select" id="ruangan" name="ruangan"></select>
                </div>
            </div>

            <div class="d-grid mt-3">
                <button type="submit" class="btn btn-primary fw-bold btn-lg">
                    <i class="bi {% if edit_mode %}bi-arrow-clockwise{% else %}bi-save-fill{% endif %} me-2"></i>
                    {% if edit_mode %}Update Jadwal{% else %}Simpan Booking Baru{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const lokasiSection = document.getElementById('lokasi-section');
    const gedungSelect = document.getElementById('gedung');
    const lantaiSelect = document.getElementById('lantai');
    const ruanganSelect = document.getElementById('ruangan');
    const tipeKelasSwitch = document.getElementById('tipe_kelas_switch');
    const tipeKelasHiddenInput = document.getElementById('tipe_kelas');
    const form_data = {{ form_data|tojson|safe }};

    function populateDropdown(selectElement, items, selectedValue) {
        selectElement.innerHTML = '<option value="">-- Pilih --</option>';
        items.forEach(item => {
            const option = new Option(item.nama, item.id);
            if (item.id == selectedValue) {
                option.selected = true;
            }
            selectElement.add(option);
        });
    }

    async function updateLantai() {
        const gedungId = gedungSelect.value;
        lantaiSelect.innerHTML = '<option value="">Memuat...</option>';
        ruanganSelect.innerHTML = '<option value="">--</option>';
        if (gedungId) {
            const response = await fetch(`/api/lantai/${gedungId}`);
            const lantaiData = await response.json();
            populateDropdown(lantaiSelect, lantaiData, form_data.lantai);
            if (form_data.lantai) {
                updateRuangan();
                form_data.lantai = null;
            }
        }
    }

    async function updateRuangan() {
        const lantaiId = lantaiSelect.value;
        ruanganSelect.innerHTML = '<option value="">Memuat...</option>';
        if (lantaiId) {
            const response = await fetch(`/api/ruangan/${lantaiId}`);
            const ruanganData = await response.json();
            populateDropdown(ruanganSelect, ruanganData, form_data.ruangan);
            form_data.ruangan = null;
        }
    }
    
    function handleTipeKelasChange() {
        if (tipeKelasSwitch.checked) {
            lokasiSection.style.display = 'flex';
            tipeKelasHiddenInput.value = 'Offline';
            gedungSelect.required = true;
            lantaiSelect.required = true;
            ruanganSelect.required = true;
        } else {
            lokasiSection.style.display = 'none';
            tipeKelasHiddenInput.value = 'Online';
            gedungSelect.required = false;
            lantaiSelect.required = false;
            ruanganSelect.required = false;
        }
    }

    gedungSelect.addEventListener('change', updateLantai);
    lantaiSelect.addEventListener('change', updateRuangan);
    tipeKelasSwitch.addEventListener('change', handleTipeKelasChange);

    async function initialLoad() {
        const response = await fetch("{{ url_for('routes.api_gedung') }}");
        const gedungData = await response.json();
        populateDropdown(gedungSelect, gedungData, form_data.gedung);
        
        handleTipeKelasChange();
        
        if (form_data.gedung) {
            updateLantai();
            form_data.gedung = null;
        }
    }

    initialLoad();
});
</script>
{% endblock %}